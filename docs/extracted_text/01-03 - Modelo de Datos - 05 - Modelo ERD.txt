1) ERD lógico — Relaciones formales (con cardinalidades)1.1 Núcleo: Pieza, Estado, Ubicación, ClasificaciónR-01 inv_item → inv_operational_stateRelación: inv_operational_state (1) ── (N) inv_itemFK: inv_item.operational_state_id → inv_operational_state.state_idNOT NULL: SíON DELETE: RESTRICT (no se puede borrar un estado usado por piezas)RF: Estado operativo actual y su consistencia → RF-INV-020/021/024 02-01 - DOCUMENTO RFR-02 inv_item → inv_locationRelación: inv_location (1) ── (N) inv_itemFK: inv_item.location_id → inv_location.location_idNOT NULL: SíON DELETE: RESTRICTRF: Ubicación obligatoria y trazabilidad por movimientos → RF-INV-040/042R-03 inv_category → inv_subcategoryRelación: inv_category (1) ── (N) inv_subcategoryFK: inv_subcategory.category_id → inv_category.category_idNOT NULL: SíUNIQUE: recomendado UNIQUE(category_id, subcategory_name)ON DELETE: RESTRICT (no borrar categorías con subcategorías)RF: Gestión de clasificación (catálogos) → RF-INV-030/031 02-01 - DOCUMENTO RFR-04 inv_item → (inv_category, inv_subcategory) con consistencia garantizadaPara que no exista Category=Anillos con Subcategory=Pendientes, la consistencia debe ser obligatoria en BD.Opción recomendada (formal, sin interpretación): tabla puente normadainv_category_subcategory (PK: category_id + subcategory_id)Relación:inv_category_subcategory (1) ── (N) inv_itemFK compuesto:inv_item.(category_id, subcategory_id) → inv_category_subcategory.(category_id, subcategory_id)NOT NULL: Sí en ambos camposON DELETE: RESTRICTRF: Clasificación obligatoria + coherencia de ficha dinámica por subcategoría → RF-INV-030/031/0361.2 Catálogo de atributos + reglas por subcategoría (Anexos B y C)R-05 inv_attribute → inv_subcategory_attributeRelación: inv_attribute (1) ── (N) inv_subcategory_attributeFK: inv_subcategory_attribute.attribute_id → inv_attribute.attribute_idNOT NULL: SíON DELETE: RESTRICTRF: Catálogo de atributos + asignación por subcategoría → RF-INV-032/033 02-01 - DOCUMENTO RFR-06 inv_subcategory → inv_subcategory_attributeRelación: inv_subcategory (1) ── (N) inv_subcategory_attributeFK: inv_subcategory_attribute.subcategory_id → inv_subcategory.subcategory_idNOT NULL: SíUNIQUE: UNIQUE(subcategory_id, attribute_id) (un atributo solo una vez por subcategoría)ON DELETE: RESTRICTRF: Ficha dinámica por subcategoría y obligatoriedad O/OP/C/NA → RF-INV-033/036Nota: aquí es donde queda “legalmente” representado el Anexo C (O/OP/C/NA). 01-02 - FRaD - Anexo C - Defini…1.3 Dominios y valores controlados (Anexo D)R-07 inv_domain → inv_domain_valueRelación: inv_domain (1) ── (N) inv_domain_valueFK: inv_domain_value.domain_id → inv_domain.domain_idNOT NULL: SíUNIQUE: UNIQUE(domain_id, value_label)ON DELETE: RESTRICTRF: Dominios y valores controlados → RF-INV-034/035R-08 inv_domain → inv_attribute (solo para atributos tipo lista)Relación: inv_domain (1) ── (N) inv_attributeFK: inv_attribute.domain_id → inv_domain.domain_idNULLABLE: Sí (porque solo aplica a atributos LISTA)CHECK (integridad tipada):si inv_attribute.data_type = 'list' ⇒ domain_id IS NOT NULLsi data_type != 'list' ⇒ domain_id IS NULLON DELETE: RESTRICTRF: Atributos listados deben usar dominio (sin listas libres) → RF-INV-032/0341.4 Valores por pieza (ficha dinámica persistida)R-09 inv_item → inv_item_attribute_valueRelación: inv_item (1) ── (N) inv_item_attribute_valueFK: inv_item_attribute_value.item_id → inv_item.item_idNOT NULL: SíUNIQUE: UNIQUE(item_id, attribute_id) (un valor vigente por atributo y pieza)ON DELETE: CASCADE (si se elimina una pieza, se eliminan sus valores; si no hay borrado físico de pieza, no aplica)RF: Ficha consultable completa + persistencia de atributos → RF-INV-013/036R-10 inv_attribute → inv_item_attribute_valueRelación: inv_attribute (1) ── (N) inv_item_attribute_valueFK: inv_item_attribute_value.attribute_id → inv_attribute.attribute_idON DELETE: RESTRICTRF: Reutilización de atributos (no ad-hoc) → RF-INV-032R-11 inv_domain_value → inv_item_attribute_value (cuando el atributo es LISTA)Relación: inv_domain_value (1) ── (N) inv_item_attribute_valueFK: inv_item_attribute_value.domain_value_id → inv_domain_value.domain_value_idNULLABLE: SíCHECK: si el atributo es LISTA ⇒ domain_value_id IS NOT NULLRegla cruzada (service/trigger): domain_value.domain_id == attribute.domain_idRF: Integridad de valores controlados → RF-INV-034/035/0361.5 Movimientos (trazabilidad operativa)R-12 inv_item → inv_movementRelación: inv_item (1) ── (N) inv_movementFK: inv_movement.item_id → inv_item.item_idNOT NULL: SíON DELETE: RESTRICT o CASCADE (según política de borrado; recomendado RESTRICT y baja lógica de pieza)RF: Historial obligatorio y no editable → RF-INV-040–044R-13 inv_location → inv_movement (from/to)Relación: inv_location (1) ── (N) inv_movement (dos FKs)FKs: from_location_id, to_location_id → inv_location.location_idNULLABLE: Sí (según tipo de evento)ON DELETE: RESTRICTRF: Movimiento registra origen/destino cuando aplica → RF-INV-042R-14 inv_operational_state → inv_movement (from/to)Relación: inv_operational_state (1) ── (N) inv_movement (dos FKs)FKs: from_state_id, to_state_id → inv_operational_state.state_idNULLABLE: Sí (según evento)ON DELETE: RESTRICTRF: Movimiento registra cambios de estado → RF-INV-040–042R-15 Inmutabilidad operativa de inv_item (bloqueo sin movimiento)Regla de integridad (no solo FK):Prohibido actualizar inv_item.location_id o inv_item.operational_state_id sin insertar inv_movement correlacionado (misma transacción).Implementación: trigger/servicio con transacción atómicaRF: “No permitir cambios sin movimiento” → RF-INV-041 02-01 - DOCUMENTO RF1.6 Apartados, reparaciones, garantías, impresión etiquetas (tablas “satélite” de inventario)Estas tablas existen como soporte operativo en RF/matriz/casos de prueba; se relacionan siempre a inv_item como troncal.R-16 inv_item → inv_reservationCardinalidad: inv_item (1) ── (0..N) inv_reservation (histórico), y a la vez solo 0..1 activaFK: inv_reservation.item_id → inv_item.item_id (NN)UNIQUE condicional: “una reserva activa por pieza”ON DELETE: RESTRICTRF: Reserva/apartado y su control → RF-INV-050–055R-17 inv_item → inv_repair_orderCardinalidad: inv_item (1) ── (0..N) inv_repair_orderFK: inv_repair_order.item_id → inv_item.item_id (NN)ON DELETE: RESTRICTRF: Reparación/personalización y trazabilidad → RF-INV-060–064R-18 inv_item → inv_warrantyCardinalidad: inv_item (1) ── (0..N) inv_warranty (si se versiona), o 0..1 si solo se guarda la vigenteFK: inv_warranty.item_id → inv_item.item_id (NN)ON DELETE: RESTRICTRF: Garantía ligada a venta y pieza → RF-INV-070–072 02-03 - Casos de pruebaR-19 inv_item → inv_label_print_logCardinalidad: inv_item (1) ── (0..N) inv_label_print_logFK: inv_label_print_log.item_id → inv_item.item_id (NN)ON DELETE: RESTRICTRF: Impresión/reimpresión de etiquetas con trazabilidad → RF-INV-090–0922) Reglas de integridad por entidad (con RF-INV)A continuación, las “reglas por entidad” en formato que un dev puede implementar como constraints + reglas de servicio.2.1 inv_item — ReglasUnicidad de pieza: item_id único e inmutable → RF-INV-002/003 02-01 - DOCUMENTO RFIdentificación visible: item_code UNIQUE, item_qr_value UNIQUE → RF-INV-011/012 02-01 - DOCUMENTO RFClasificación obligatoria: category_id NN y subcategory_id NN → RF-INV-030/031 02-01 - DOCUMENTO RFConsistencia clasificación: FK compuesto a inv_category_subcategory → RF-INV-036Estado y ubicación obligatorios: operational_state_id NN, location_id NN → RF-INV-020/021/040/042Bloqueo de cambios directos estado/ubicación sin inv_movement → RF-INV-041 02-01 - DOCUMENTO RFFicha consultable completa (join de núcleo + atributos + historial) → RF-INV-013 02-01 - DOCUMENTO RF2.2 inv_attribute — ReglasDefinición única y reutilizable (attribute_key UNIQUE) → RF-INV-032Tipado: data_type obligatorio; si LISTA ⇒ domain_id obligatorio → RF-INV-032/0342.3 inv_subcategory_attribute — ReglasUna regla por atributo y subcategoría: UNIQUE(subcategory_id, attribute_id) → RF-INV-033 02-01 - DOCUMENTO RFObligatoriedad O/OP/C/NA y uso en ficha dinámica → RF-INV-033/036Si C ⇒ expresión/estructura condicional obligatoria (en tu modelo actual lo tenías en condition_expression, o en tablas de reglas) → RF-INV-036 02-04 - MATRIZ PANTALLA2.4 inv_domain / inv_domain_value — ReglasDominios y valores controlados (no listas libres) → RF-INV-034/035Unicidad valor dentro de dominio: UNIQUE(domain_id, value_label) → RF-INV-035 02-01 - DOCUMENTO RF2.5 inv_item_attribute_value — ReglasUn valor vigente por atributo: UNIQUE(item_id, attribute_id) → RF-INV-036Validación tipada por data_type (solo un slot de valor) → RF-INV-036 02-04 - MATRIZ PANTALLASi LISTA: domain_value_id obligatorio y consistente con dominio del atributo → RF-INV-034/035/036No guardar NA (si Anexo C marca NA) y exigir O/C cuando aplique → RF-INV-033/0362.6 inv_movement — ReglasToda modificación de estado/ubicación debe registrarse como movimiento → RF-INV-040–044Movimiento debe tener mínimos (item, usuario, fecha, motivo; from/to cuando aplica) → RF-INV-042Prohibir cambios directos sin movimiento → RF-INV-041 02-01 - DOCUMENTO RF3) Política ON DELETE / ON UPDATE (estándar recomendado LES)Para evitar roturas de trazabilidad (inventario troncal):Catálogos (inv_category, inv_subcategory, inv_attribute, inv_domain, inv_domain_value, inv_operational_state, inv_location):ON DELETE RESTRICTBaja lógica (is_active=false) en lugar de borrado físicoJustificación: preserva integridad histórica y evita huérfanos.Datos (inv_item): recomendado no borrar físico; si se borra por normativa:inv_item_attribute_value: ON DELETE CASCADE (técnico)inv_movement: mejor RESTRICT (para no perder trazabilidad) y “soft delete” de item.
